//
//  ScheduleViewController.swift
//  FSPO-Viper
//
//  Created Николай Борисов on 06/07/2018.
//  Copyright © 2018 Николай Борисов. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit
import LayoutKit
class ScheduleViewController: UIViewController, ScheduleViewProtocol {
    private var scrollView: UIScrollView!
	var presenter: SchedulePresenterProtocol?
    private var studentScheduleLayoutAdapter: ReloadableViewLayoutAdapter?
    private var scheduleByGroupsLayoutAdapter: ReloadableViewLayoutAdapter?
    private var teachersListLayoutAdapter: ReloadableViewLayoutAdapter?
	override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white
        scrollView = UIScrollView(frame: view.bounds)
        scrollView.autoresizingMask = [.flexibleWidth, .flexibleHeight]
        scrollView.isPagingEnabled = true
        view.addSubview(scrollView)
        self.layoutFeed(width: self.view.bounds.width)
    }
    func getNewsRows() -> [Layout]? {
        let layouts = [Layout](repeating: NewsPostLayout(body: "asd", time: "2"), count: 100)
        return layouts
    }
    private func reloadTableView(width: CGFloat, synchronous: Bool, layoutAdapter: ReloadableViewLayoutAdapter, ds: [Section<[Layout]>]) {
        layoutAdapter.reloading(width: width, synchronous: synchronous, layoutProvider: {
            return ds
        })
    }
    func getStudentRows() -> [Layout]? {
        let layouts = [Layout](repeating: StudentScheduleCellLayout(subject: "", teacher: "", subjects: 2), count: 1)
        return layouts
    }
    func getGroupsRows() -> [Layout]? {
        let layouts = [Layout](repeating: ScheduleByGroupsCellLayout(group: "Y2135"), count: 4)
        return layouts
    }
    func setupLayoutAdapters() {
        self.studentScheduleLayoutAdapter = StudentScheduleReloadableLayoutAdapter(reloadableView: StudentScheduleLayout.tableView ?? UITableView())
        StudentScheduleLayout.tableView?.dataSource = self.studentScheduleLayoutAdapter
        StudentScheduleLayout.tableView?.delegate = self.studentScheduleLayoutAdapter
        self.reloadTableView(width: self.view.bounds.width, synchronous: false, layoutAdapter: self.studentScheduleLayoutAdapter!, ds: [Section(
            header: nil,
            items: getStudentRows() ?? [],
            footer: nil), Section(
                header: nil,
                items: getStudentRows() ?? [],
                footer: nil), Section(
                    header: nil,
                    items: getStudentRows() ?? [],
                    footer: nil), Section(
                        header: nil,
                        items: getStudentRows() ?? [],
                        footer: nil), Section(
                            header: nil,
                            items: getStudentRows() ?? [],
                            footer: nil), Section(
                                header: nil,
                                items: getStudentRows() ?? [],
                                footer: nil)])
        self.scheduleByGroupsLayoutAdapter = ScheduleByGroupsReloadableLayoutAdapter(reloadableView: ScheduleByGroupsLayout.tableView ?? UITableView())
        ScheduleByGroupsLayout.tableView?.dataSource = self.scheduleByGroupsLayoutAdapter
        ScheduleByGroupsLayout.tableView?.delegate = self.scheduleByGroupsLayoutAdapter
        self.reloadTableView(width: self.view.bounds.width, synchronous: false, layoutAdapter:
            self.scheduleByGroupsLayoutAdapter!, ds: [Section(
            header: nil,
            items: getGroupsRows() ?? [],
            footer: nil), Section(
                header: nil,
                items: getGroupsRows() ?? [],
                footer: nil), Section(
                    header: nil,
                    items: getGroupsRows() ?? [],
                    footer: nil), Section(
                        header: nil,
                        items: getGroupsRows() ?? [],
                        footer: nil)])
        self.teachersListLayoutAdapter = NewsReloadableViewLayoutAdapter(reloadableView: TeachersListLayout.tableView ?? UITableView())
        TeachersListLayout.tableView?.dataSource = self.teachersListLayoutAdapter
        TeachersListLayout.tableView?.delegate = self.teachersListLayoutAdapter
        self.reloadTableView(width: self.view.bounds.width, synchronous: false, layoutAdapter: self.teachersListLayoutAdapter!, ds: [Section(
            header: nil,
            items: getNewsRows() ?? [],
            footer: nil)])
    }
    private func layoutFeed(width: CGFloat) {
        _ = CFAbsoluteTimeGetCurrent()
        DispatchQueue.global(qos: DispatchQoS.QoSClass.userInitiated).async {
            let scheduleLayout = ScheduleLayout()
            let arrangement = scheduleLayout.arrangement(width: width * 3)
            DispatchQueue.main.async(execute: {
                self.scrollView.contentSize = arrangement.frame.size
                arrangement.makeViews(in: self.scrollView)
                self.setupLayoutAdapters()
                _ = CFAbsoluteTimeGetCurrent()
            })
        }
    }

}
